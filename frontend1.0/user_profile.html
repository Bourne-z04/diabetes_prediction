<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>个人资料 - 糖尿病预测系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="user_dashboard.html"><i class="fas fa-heartbeat me-2"></i>糖尿病预测系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user_dashboard.html"><i class="fas fa-file-medical-alt me-1"></i>健康信息</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user_history.html"><i class="fas fa-history me-1"></i>历史记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="openAiChatModal" data-bs-toggle="modal" data-bs-target="#aiChatModal">
                            <i class="fas fa-robot me-1"></i>AI 助手
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="openFeedbackModal" data-bs-toggle="modal" data-bs-target="#feedbackModal"><i class="fas fa-comment-dots me-1"></i>提交反馈</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-user-cog me-1"></i>个人资料</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <img src="images/logo.jpg" alt="Logo" class="me-2" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                    <span class="navbar-text me-3" id="userWelcome"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4">个人资料管理</h2>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <img src="images/logo.jpg" alt="个人头像" class="profile-picture" id="avatarImg" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;">
                        <h4 id="profileUsername">加载中...</h4>
                        <p class="text-muted" id="profileEmail">加载中...</p>
                        <p class="text-muted" id="profileRole">用户类型: 加载中...</p>
                        <p class="text-muted" id="profileSince">注册时间: 加载中...</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">更新个人信息</h5>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">邮箱</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">新密码（留空表示不修改）</label>
                                <input type="password" class="form-control" id="password">
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">确认新密码</label>
                                <input type="password" class="form-control" id="confirmPassword">
                            </div>
                            <button type="submit" class="btn btn-primary">更新个人资料</button>
                        </form>
                        <div id="result"></div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">账户统计</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h3 id="statsRecords">0</h3>
                                    <p class="text-muted mb-0">健康记录数</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h3 id="statsLastTest">-</h3>
                                    <p class="text-muted mb-0">最近一次检测</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户反馈模态框 -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">提交反馈</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="feedbackForm">
                        <div class="mb-3">
                            <label for="feedbackContent" class="form-label">反馈内容</label>
                            <textarea class="form-control" id="feedbackContent" rows="5" placeholder="请描述您的使用体验、建议或遇到的问题..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="contactInfo" class="form-label">联系方式（选填）</label>
                            <input type="text" class="form-control" id="contactInfo" placeholder="电话/邮箱/微信等">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitFeedback">提交</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI 聊天模态框 -->
    <div class="modal fade" id="aiChatModal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiChatModalLabel"><i class="fas fa-robot"></i> AI 助手</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="aiChatBox" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #f9f9f9;">
                        <!-- 聊天内容将显示在这里 -->
                        <div class="text-muted text-center">你好！我是您的 AI 助手，有什么可以帮助您的吗？</div>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="aiPromptInput" placeholder="请输入您的问题...">
                        <button class="btn btn-primary" type="button" id="sendAiPrompt">
                            <i class="fas fa-paper-plane"></i> 发送
                        </button>
                    </div>
                    <div id="aiCharError" class="text-danger mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        // 页面加载完成后检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            const auth = checkAuth();
            if (!auth) return;
            
            // 显示用户名
            document.getElementById('userWelcome').textContent = `欢迎, ${auth.currentUser.username}`;
            
            // 加载用户资料
            loadUserProfile(auth.token, auth.currentUser.id);
            
            // 加载用户统计信息
            loadUserStats(auth.token);
            
            // 表单提交事件
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateProfile(auth.token, auth.currentUser.id);
            });
            
            // 反馈提交事件
            document.getElementById('submitFeedback').addEventListener('click', function() {
                submitFeedback(auth.token);
            });
            
            // AI 聊天发送按钮事件
            const sendAiPromptButton = document.getElementById('sendAiPrompt');
            if (sendAiPromptButton) {
                sendAiPromptButton.addEventListener('click', function() {
                    sendAiQuery(auth.token);
                });
            }

            // AI 聊天输入框回车事件
            const aiPromptInput = document.getElementById('aiPromptInput');
            if (aiPromptInput) {
                aiPromptInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // 防止表单提交（如果是在form内）
                        sendAiQuery(auth.token);
                    }
                });
            }
        });
        
        // 加载用户资料
        async function loadUserProfile(token, userId) {
            try {
                const user = await apiRequest(`/user/profile`, 'POST', { user_id: userId }, token);
                
                // 填充页面信息
                document.getElementById('profileUsername').textContent = user.username;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileRole').textContent = `用户类型: ${user.role_id === 2 ? '管理员' : '普通用户'}`;
                document.getElementById('profileSince').textContent = `注册时间: 未知`; // 处理没有created_at字段的情况
                
                // 填充表单
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                
            } catch (error) {
                showMessage(`获取用户资料失败: ${error.message}`, 'error');
            }
        }
        
        // 加载用户统计信息
        async function loadUserStats(token) {
            try {
                const stats = await apiRequest(`/user/stats`, 'POST', null, token);
                
                document.getElementById('statsRecords').textContent = stats.records_count || 0;
                
                if (stats.last_test_date) {
                    document.getElementById('statsLastTest').textContent = new Date(stats.last_test_date).toLocaleDateString();
                }
                
            } catch (error) {
                showMessage(`获取统计信息失败: ${error.message}`, 'error');
            }
        }
        
        // 更新个人资料
        async function updateProfile(token, userId) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password && password !== confirmPassword) {
                showMessage('两次输入的密码不一致', 'error');
                return;
            }
            
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
            };
            
            if (password) {
                data.password = password;
            }
            
            try {
                const result = await apiRequest(`/user/profile`, 'PUT', data, token);
                showMessage('个人资料更新成功！', 'success');
                
                // 更新导航栏中的用户名显示
                document.getElementById('userWelcome').textContent = `欢迎, ${data.username}`;
                
                // 更新本地存储中的用户名
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                currentUser.username = data.username;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
            } catch (error) {
                showMessage(`更新失败: ${error.message}`, 'error');
            }
        }
        
        // 提交用户反馈
        async function submitFeedback(token) {
            const content = document.getElementById('feedbackContent').value;
            const contact = document.getElementById('contactInfo').value;
            
            if (!content) {
                showMessage('反馈内容不能为空', 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/user/feedback', 'POST', {
                    content,
                    contact
                }, token);
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                modal.hide();
                
                // 清空表单
                document.getElementById('feedbackContent').value = '';
                document.getElementById('contactInfo').value = '';
                
                showMessage('感谢您的反馈！我们会尽快处理', 'success');
            } catch (error) {
                showMessage(`提交反馈失败: ${error.message}`, 'error');
            }
        }
        
        // 发送AI查询
        async function sendAiQuery(token) {
            const promptInput = document.getElementById('aiPromptInput');
            const query = promptInput.value.trim();
            
            if (!query) return;
            
            const chatBox = document.getElementById('aiChatBox');
            const errorDiv = document.getElementById('aiCharError');
            
            // 清空错误信息
            errorDiv.textContent = '';
            
            // 添加用户消息
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'mb-2 text-end';
            userMsgDiv.innerHTML = `<span class="bg-primary text-white rounded px-3 py-2 d-inline-block">${query}</span>`;
            chatBox.appendChild(userMsgDiv);
            
            // 清空输入框
            promptInput.value = '';
            
            // 添加AI思考消息
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.className = 'mb-2';
            aiMsgDiv.innerHTML = `<span class="bg-light rounded px-3 py-2 d-inline-block"><i class="fas fa-spinner fa-spin me-2"></i>思考中...</span>`;
            chatBox.appendChild(aiMsgDiv);
            
            // 滚动到底部
            chatBox.scrollTop = chatBox.scrollHeight;
            
            try {
                const response = await apiRequest('/ai/chat', 'POST', { prompt: query }, token);
                
                // 更新AI回复
                aiMsgDiv.innerHTML = `<span class="bg-light rounded px-3 py-2 d-inline-block">${response.response}</span>`;
                
            } catch (error) {
                // 显示错误消息
                aiMsgDiv.innerHTML = `<span class="bg-danger text-white rounded px-3 py-2 d-inline-block">抱歉，发生了错误: ${error.message}</span>`;
                errorDiv.textContent = `错误: ${error.message}`;
            }
            
            // 再次滚动到底部
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // 显示消息
        function showMessage(message, type = 'success') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = type;
            resultDiv.textContent = message;
            
            // 5秒后自动隐藏
            setTimeout(() => {
                resultDiv.textContent = '';
                resultDiv.className = '';
            }, 5000);
        }
    </script>
</body>
</html> 