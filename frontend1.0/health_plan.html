<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>健康方案 - 糖尿病预测系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .container { 
            padding-top: 80px;
            margin-bottom: 50px;
            position: relative;
            z-index: 1;
        }
        .card { 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            background-color: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="user_dashboard.html"><i class="fas fa-heartbeat me-2"></i>糖尿病预测系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user_dashboard.html"><i class="fas fa-file-medical-alt me-1"></i>健康信息</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user_history.html"><i class="fas fa-history me-1"></i>历史记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-notes-medical me-1"></i>健康方案</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ai_assistant.html"><i class="fas fa-robot me-1"></i>AI 助手</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="openFeedbackModal" data-bs-toggle="modal" data-bs-target="#feedbackModal"><i class="fas fa-comment-dots me-1"></i>提交反馈</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user_profile.html"><i class="fas fa-user-cog me-1"></i>个人资料</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <img src="images/logo.jpg" alt="Logo" class="me-2" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                    <span class="navbar-text me-3" id="userWelcome"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>请填写以下信息，系统将为您生成个性化健康方案提示。您可以将生成的提示复制给AI助手，获取详细的建议。
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 基础信息 -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>基础信息</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">性别</label>
                            <select class="form-select" id="plan-gender">
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">年龄</label>
                            <input type="number" class="form-control" id="plan-age" min="1" max="120" placeholder="1-120岁">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">身高 (cm)</label>
                            <input type="number" class="form-control" id="plan-height" min="50" max="250" placeholder="50-250 cm">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">体重 (kg)</label>
                            <input type="number" class="form-control" id="plan-weight" min="20" max="300" placeholder="20-300 kg">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">糖尿病类型</label>
                            <select class="form-select" id="plan-diabetesType">
                                <option value="1型糖尿病">1型糖尿病</option>
                                <option value="2型糖尿病">2型糖尿病</option>
                                <option value="妊娠期糖尿病">妊娠期糖尿病</option>
                                <option value="其他类型糖尿病">其他类型糖尿病</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">患病时长 (年)</label>
                            <input type="number" class="form-control" id="plan-diseaseDuration" min="0" max="100" placeholder="0-100年">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 健康指标 -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>健康指标</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">空腹血糖 (mmol/L)</label>
                            <input type="number" class="form-control" id="plan-fastingBloodGlucose" min="0" max="40" step="0.1" placeholder="3.9-10.0 mmol/L">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">餐后2小时血糖 (mmol/L)</label>
                            <input type="number" class="form-control" id="plan-postprandialGlucose" min="0" max="40" step="0.1" placeholder="3.9-13.9 mmol/L">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">糖化血红蛋白 (%)</label>
                            <input type="number" class="form-control" id="plan-hba1c" min="0" max="20" step="0.1" placeholder="4.0-15.0 %">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">腰围 (cm)</label>
                            <input type="number" class="form-control" id="plan-waistline" min="30" max="200" placeholder="男性<90cm，女性<85cm">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">日常运动量</label>
                            <select class="form-select" id="plan-activityLevel">
                                <option value="几乎不运动">几乎不运动</option>
                                <option value="轻度运动">轻度运动 (每周1-3次)</option>
                                <option value="中度运动">中度运动 (每周3-5次)</option>
                                <option value="高强度运动">高强度运动 (每周5次以上)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 生活方式 -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-utensils me-2"></i>生活方式</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">日常饮食习惯</label>
                            <textarea class="form-control" id="plan-dietHabits" rows="2" placeholder="例如：每日三餐规律、喜欢甜食、主食以米饭为主等（10-200字）"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">食物过敏/禁忌</label>
                            <input type="text" class="form-control" id="plan-foodAllergies" placeholder="例如：海鲜过敏、乳糖不耐受等（如无请填"无"）">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">睡眠质量</label>
                            <select class="form-select" id="plan-sleepQuality">
                                <option value="很好">很好 (每晚7-8小时深度睡眠)</option>
                                <option value="一般">一般 (睡眠时间足够但质量一般)</option>
                                <option value="较差">较差 (易醒，难以入睡)</option>
                                <option value="很差">很差 (长期失眠)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">压力水平</label>
                            <select class="form-select" id="plan-stressLevel">
                                <option value="几乎没有压力">几乎没有压力</option>
                                <option value="轻度压力">轻度压力</option>
                                <option value="中度压力">中度压力</option>
                                <option value="高度压力">高度压力</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 用药情况 -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-pills me-2"></i>用药情况</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">目前服用的降糖药</label>
                            <textarea class="form-control" id="plan-currentMedication" rows="2" placeholder="例如：二甲双胍850mg，每日两次（如无服药请填"无"）"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">是否使用胰岛素</label>
                            <select class="form-select" id="plan-insulinUse">
                                <option value="否">否</option>
                                <option value="是">是</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">其他慢性病</label>
                            <input type="text" class="form-control" id="plan-otherDiseases" placeholder="例如：高血压、高脂血症等（如无请填"无"）">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 按钮 -->
            <div class="col-12 text-center mb-3">
                <button class="btn btn-primary btn-lg" onclick="generateHealthPrompt()">
                    <i class="fas fa-magic me-2"></i>生成健康方案提示
                </button>
            </div>
            
            <!-- 提示内容 -->
            <div class="col-12" id="healthPromptResult" style="display: none;">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">生成的提示</h5>
                        <div>
                            <button class="btn btn-sm btn-success me-2" id="copyHealthPrompt">
                                <i class="fas fa-copy me-1"></i>复制到剪贴板
                            </button>
                            <button class="btn btn-sm btn-primary" id="sendToAiBtn">
                                <i class="fas fa-paper-plane me-1"></i>发送到AI助手
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="bg-light p-3" style="border-radius: 5px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;">
                            <code id="generatedHealthPrompt"></code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户反馈模态框 -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">提交反馈</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="feedbackForm">
                        <div class="mb-3">
                            <label for="feedbackContent" class="form-label">反馈内容</label>
                            <textarea class="form-control" id="feedbackContent" rows="5" placeholder="请详细描述您的使用体验、建议或遇到的问题（10-500字）..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="contactInfo" class="form-label">联系方式（选填）</label>
                            <input type="text" class="form-control" id="contactInfo" placeholder="电话/邮箱/微信，方便我们与您联系">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitFeedback">提交</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        // 全局变量存储用户最近的健康数据
        let latestHealthData = null;
        
        // 页面加载完成后检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            const auth = checkAuth();
            if (!auth) return;
            
            // 显示用户名
            document.getElementById('userWelcome').textContent = `欢迎, ${auth.currentUser.username}`;
            
            // 获取用户最新的健康数据
            getLatestHealthData(auth.token);
            
            // 复制健康方案提示按钮
            document.getElementById('copyHealthPrompt').addEventListener('click', function() {
                copyHealthPrompt();
            });
            
            // 发送到AI助手按钮
            document.getElementById('sendToAiBtn').addEventListener('click', function() {
                sendPromptToAi();
            });
            
            // 反馈提交事件
            document.getElementById('submitFeedback').addEventListener('click', function() {
                submitFeedback(auth.token);
            });
        });
        
        // 获取用户最新的健康数据
        async function getLatestHealthData(token) {
            try {
                // 显示加载提示
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingHealthData';
                loadingDiv.className = 'alert alert-info';
                loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在获取健康数据...';
                document.querySelector('.row:first-child .col-12').appendChild(loadingDiv);
                
                const data = await apiRequest('/user/predict', 'POST', null, token);
                
                // 移除加载提示
                const loadingElement = document.getElementById('loadingHealthData');
                if (loadingElement) loadingElement.remove();
                
                if (data && data.health_info) {
                    latestHealthData = data.health_info;
                    console.log('获取到最新健康数据:', latestHealthData);
                    
                    // 如果用户未填写年龄，使用健康数据中的年龄
                    if (latestHealthData.age) {
                        document.getElementById('plan-age').placeholder = `1-120岁 (最近记录: ${latestHealthData.age}岁)`;
                    }
                    
                    // 如果用户未填写BMI，使用健康数据中的BMI
                    if (latestHealthData.bmi) {
                        document.getElementById('plan-fastingBloodGlucose').placeholder = `3.9-10.0 mmol/L (参考: ${latestHealthData.glucose} mg/dl)`;
                    }
                    
                    // 显示成功消息
                    const successDiv = document.createElement('div');
                    successDiv.className = 'alert alert-success mt-2';
                    successDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>成功获取最新健康数据';
                    successDiv.style.opacity = '1';
                    document.querySelector('.row:first-child .col-12').appendChild(successDiv);
                    
                    // 3秒后淡出消息
                    setTimeout(() => {
                        successDiv.style.transition = 'opacity 1s';
                        successDiv.style.opacity = '0';
                        setTimeout(() => successDiv.remove(), 1000);
                    }, 3000);
                } else {
                    console.warn('获取的健康数据为空');
                    // 不显示错误，因为可能是新用户没有数据
                }
            } catch (error) {
                console.error('获取最新健康数据失败:', error);
                
                // 移除加载提示
                const loadingElement = document.getElementById('loadingHealthData');
                if (loadingElement) loadingElement.remove();
                
                // 显示错误提示，但不要阻止用户使用表单
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-warning';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>获取历史健康数据失败: ${error.message}。您仍然可以继续填写表单。`;
                document.querySelector('.row:first-child .col-12').appendChild(errorDiv);
                
                // 10秒后移除错误提示
                setTimeout(() => {
                    errorDiv.style.transition = 'opacity 1s';
                    errorDiv.style.opacity = '0';
                    setTimeout(() => errorDiv.remove(), 10000);
                }, 10000);
            }
        }
        
        // 生成健康方案提示
        function generateHealthPrompt() {
            // 获取输入的值
            const gender = document.getElementById('plan-gender').value;
            const age = document.getElementById('plan-age').value;
            const height = document.getElementById('plan-height').value;
            const weight = document.getElementById('plan-weight').value;
            const diabetesType = document.getElementById('plan-diabetesType').value;
            const diseaseDuration = document.getElementById('plan-diseaseDuration').value;
            
            const fastingBloodGlucose = document.getElementById('plan-fastingBloodGlucose').value;
            const postprandialGlucose = document.getElementById('plan-postprandialGlucose').value;
            const hba1c = document.getElementById('plan-hba1c').value;
            const waistline = document.getElementById('plan-waistline').value;
            const activityLevel = document.getElementById('plan-activityLevel').value;
            
            const dietHabits = document.getElementById('plan-dietHabits').value;
            const foodAllergies = document.getElementById('plan-foodAllergies').value;
            const sleepQuality = document.getElementById('plan-sleepQuality').value;
            const stressLevel = document.getElementById('plan-stressLevel').value;
            
            const currentMedication = document.getElementById('plan-currentMedication').value;
            const insulinUse = document.getElementById('plan-insulinUse').value;
            const otherDiseases = document.getElementById('plan-otherDiseases').value;
            
            // 验证必填字段
            if (!age || !height || !weight || !diseaseDuration || !fastingBloodGlucose) {
                showMessage('请至少填写基础信息和关键健康指标', 'error');
                return;
            }
            
            // 计算BMI
            const bmi = (weight / ((height/100) * (height/100))).toFixed(1);
            
            // 构建提示文本
            let prompt = `我是一名${age}岁${gender}性，${diabetesType}患者，患病已有${diseaseDuration}年。我身高${height}cm，体重${weight}kg，BMI为${bmi}，腰围${waistline || '未测量'}cm。

我的健康指标如下:
- 空腹血糖: ${fastingBloodGlucose} mmol/L
- 餐后2小时血糖: ${postprandialGlucose || '未测量'} mmol/L
- 糖化血红蛋白: ${hba1c || '未测量'} %
- 日常运动量: ${activityLevel}`;

            // 添加最近提交的健康数据
            if (latestHealthData) {
                prompt += `

最近的健康检测数据:
- BMI指数: ${latestHealthData.bmi || '未记录'}
- 胰岛素水平: ${latestHealthData.insulin || '未记录'} μU/ml
- 皮肤厚度: ${latestHealthData.skin_thickness || '未记录'} mm
- 葡萄糖水平: ${latestHealthData.glucose || '未记录'} mg/dl
- 检测时间: ${latestHealthData.created_at ? new Date(latestHealthData.created_at).toLocaleDateString() : '未记录'}`;
            }

            prompt += `

我的生活习惯:
- 饮食习惯: ${dietHabits || '未提供'}
- 食物过敏/禁忌: ${foodAllergies || '无'}
- 睡眠质量: ${sleepQuality}
- 压力水平: ${stressLevel}

用药情况:
- 目前服用的降糖药: ${currentMedication || '无'}
- 是否使用胰岛素: ${insulinUse}
- 其他慢性病: ${otherDiseases || '无'}

请根据我的情况，为我提供以下方面的个性化健康方案:
1. 饮食指南：请给出早、中、晚三餐的具体食谱建议，精确到食物名称和摄入量
2. 运动计划：适合我的运动类型、频率和强度
3. 血糖管理：针对我的血糖状况提供监测和控制建议
4. 用药指导：针对我目前的用药情况提供建议和注意事项
5. 生活方式调整：包括睡眠、压力管理等方面的建议

请以分点的形式回答，使建议具体可执行，谢谢！`;
            
            // 显示生成的提示
            document.getElementById('generatedHealthPrompt').textContent = prompt;
            document.getElementById('healthPromptResult').style.display = 'block';
            
            // 滚动到结果区域
            document.getElementById('healthPromptResult').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 复制健康方案提示到剪贴板
        function copyHealthPrompt() {
            const promptText = document.getElementById('generatedHealthPrompt').textContent;
            
            // 使用现代剪贴板API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(promptText)
                    .then(() => {
                        showMessage('提示已复制到剪贴板！', 'success');
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        showFallbackCopyMethod(promptText);
                    });
            } else {
                showFallbackCopyMethod(promptText);
            }
        }
        
        // 备用复制方法
        function showFallbackCopyMethod(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('提示已复制到剪贴板！', 'success');
                } else {
                    showMessage('复制失败，请手动选择文本并复制', 'error');
                }
            } catch (err) {
                showMessage('复制失败，请手动选择文本并复制', 'error');
            }
            
            document.body.removeChild(textArea);
        }
        
        // 发送提示到AI助手
        function sendPromptToAi() {
            const prompt = document.getElementById('generatedHealthPrompt').textContent;
            // 保存提示到localStorage临时存储
            localStorage.setItem('tempHealthPrompt', prompt);
            // 跳转到AI助手页面
            window.location.href = 'ai_assistant.html?prompt=health_plan';
        }
    </script>
</body>
</html> 