<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>糖尿病预测结果</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="user_dashboard.html"><i class="fas fa-heartbeat me-2"></i>糖尿病预测系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user_dashboard.html"><i class="fas fa-file-medical-alt me-1"></i>健康信息</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user_history.html"><i class="fas fa-history me-1"></i>历史记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-chart-bar me-1"></i>预测结果</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="openAiChatModal" data-bs-toggle="modal" data-bs-target="#aiChatModal">
                            <i class="fas fa-robot me-1"></i>AI 助手
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user_profile.html"><i class="fas fa-user-cog me-1"></i>个人资料</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <img src="images/logo.jpg" alt="Logo" class="me-2" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                    <span class="navbar-text me-3" id="userWelcome"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4">糖尿病预测结果</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">预测结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="probability" class="h3 mb-3"></div>
                        <p>基于您的最新健康数据，我们的模型预测您患糖尿病的风险如上所示。</p>
                        
                        <h5 class="mt-4">您的健康数据</h5>
                        <ul class="list-group" id="healthData"></ul>
                        
                        <button id="exportBtn" class="btn btn-primary mt-4">
                            <i class="fas fa-download me-1"></i> 导出预测结果
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">模型详情</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-hover-zoom">
                            <canvas id="modelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI 聊天模态框 -->
    <div class="modal fade" id="aiChatModal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiChatModalLabel"><i class="fas fa-robot"></i> AI 助手</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="aiChatBox" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #f9f9f9;">
                        <!-- 聊天内容将显示在这里 -->
                        <div class="text-muted text-center">你好！我是您的 AI 助手，有什么可以帮助您的吗？</div>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="aiPromptInput" placeholder="请输入您的问题...">
                        <button class="btn btn-primary" type="button" id="sendAiPrompt">
                            <i class="fas fa-paper-plane"></i> 发送
                        </button>
                    </div>
                    <div id="aiCharError" class="text-danger mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户是否登录
            const auth = checkAuth();
            if (!auth) return;
            
            // 显示用户名
            document.getElementById('userWelcome').textContent = `欢迎, ${auth.currentUser.username}`;
            
            // AI 聊天发送按钮事件
            const sendAiPromptButton = document.getElementById('sendAiPrompt');
            if (sendAiPromptButton) {
                sendAiPromptButton.addEventListener('click', function() {
                    sendAiQuery(auth.token);
                });
            }

            // AI 聊天输入框回车事件
            const aiPromptInput = document.getElementById('aiPromptInput');
            if (aiPromptInput) {
                aiPromptInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendAiQuery(auth.token);
                    }
                });
            }

            // 获取预测结果
            getPredictionResults(auth.token);
        });
        
        // 获取预测结果
        async function getPredictionResults(token) {
            try {
                const data = await apiRequest('/user/predict', 'GET', null, token);
                
                // 显示预测概率
                const probabilityElement = document.getElementById('probability');
                const riskLevel = data.probability > 0.5 ? 'high-risk' : 'low-risk';
                probabilityElement.textContent = `糖尿病风险: ${(data.probability * 100).toFixed(1)}%`;
                probabilityElement.classList.add(riskLevel);
                
                // 显示健康数据
                const healthDataElement = document.getElementById('healthData');
                const healthInfo = data.health_info;
                healthDataElement.innerHTML = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        年龄
                        <span>${healthInfo.age}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        BMI指数
                        <span>${healthInfo.bmi}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        胰岛素水平
                        <span>${healthInfo.insulin}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        皮肤厚度
                        <span>${healthInfo.skin_thickness}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        葡萄糖水平
                        <span>${healthInfo.glucose}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        检测时间
                        <span>${new Date(healthInfo.created_at).toLocaleString()}</span>
                    </li>
                `;
                
                // 绘制模型详情图表
                const ctx = document.getElementById('modelChart').getContext('2d');
                const modelData = Object.entries(data.model_details || {}).map(([name, detail]) => ({
                    model: name,
                    probability: detail.probability
                }));
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: modelData.map(item => item.model),
                        datasets: [{
                            label: '预测概率',
                            data: modelData.map(item => item.probability * 100),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: '概率(%)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: '各模型预测概率'
                            }
                        }
                    }
                });
                
                // 导出功能
                document.getElementById('exportBtn').addEventListener('click', () => {
                    exportPrediction(token);
                });
            } catch (error) {
                showMessage(`获取预测结果失败: ${error.message}`, 'error');
            }
        }
        
        // 导出预测结果
        async function exportPrediction(token) {
            try {
                const response = await fetch(`${API_BASE}/user/predict?export=true`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('导出失败');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `diabetes_prediction_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage('预测结果导出成功', 'success');
            } catch (error) {
                showMessage(`导出失败: ${error.message}`, 'error');
            }
        }
        
        // 发送AI查询
        async function sendAiQuery(token) {
            const promptInput = document.getElementById('aiPromptInput');
            const query = promptInput.value.trim();
            
            if (!query) return;
            
            const chatBox = document.getElementById('aiChatBox');
            const errorDiv = document.getElementById('aiCharError');
            
            // 清空错误信息
            errorDiv.textContent = '';
            
            // 添加用户消息
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'mb-2 text-end';
            userMsgDiv.innerHTML = `<span class="bg-primary text-white rounded px-3 py-2 d-inline-block">${query}</span>`;
            chatBox.appendChild(userMsgDiv);
            
            // 清空输入框
            promptInput.value = '';
            
            // 添加AI思考消息
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.className = 'mb-2';
            aiMsgDiv.innerHTML = `<span class="bg-light rounded px-3 py-2 d-inline-block"><i class="fas fa-spinner fa-spin me-2"></i>思考中...</span>`;
            chatBox.appendChild(aiMsgDiv);
            
            // 滚动到底部
            chatBox.scrollTop = chatBox.scrollHeight;
            
            try {
                const response = await apiRequest('/ai/chat', 'POST', { prompt: query }, token);
                
                // 更新AI回复
                aiMsgDiv.innerHTML = `<span class="bg-light rounded px-3 py-2 d-inline-block">${response.response}</span>`;
                
            } catch (error) {
                // 显示错误消息
                aiMsgDiv.innerHTML = `<span class="bg-danger text-white rounded px-3 py-2 d-inline-block">抱歉，发生了错误: ${error.message}</span>`;
                errorDiv.textContent = `错误: ${error.message}`;
            }
            
            // 再次滚动到底部
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // 显示消息
        function showMessage(message, type = 'success') {
            // 创建一个警告框
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.textContent = message;
            
            // 添加关闭按钮
            const closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'btn-close';
            closeButton.setAttribute('data-bs-dismiss', 'alert');
            closeButton.setAttribute('aria-label', 'Close');
            alertDiv.appendChild(closeButton);
            
            // 将警告框添加到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 5秒后自动关闭
            setTimeout(() => {
                const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                alert.close();
            }, 5000);
        }
    </script>
</body>
</html>