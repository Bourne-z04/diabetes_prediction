<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>健康记录历史 - 糖尿病预测系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .container { padding-top: 30px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .record-card { transition: all 0.3s ease; cursor: pointer; }
        .record-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .high-risk { color: #dc3545; font-weight: bold; }
        .low-risk { color: #28a745; font-weight: bold; }
        #result { margin: 15px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .table th { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="user_dashboard.html"><i class="fas fa-heartbeat me-2"></i>糖尿病预测系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user_dashboard.html"><i class="fas fa-file-medical-alt me-1"></i>健康信息</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-history me-1"></i>历史记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="openAiChatModal" data-bs-toggle="modal" data-bs-target="#aiChatModal">
                            <i class="fas fa-robot me-1"></i>AI 助手
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="openFeedbackModal" data-bs-toggle="modal" data-bs-target="#feedbackModal"><i class="fas fa-comment-dots me-1"></i>提交反馈</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user_profile.html"><i class="fas fa-user-cog me-1"></i>个人资料</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <img src="images/logo.jpg" alt="Logo" class="me-2" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                    <span class="navbar-text me-3" id="userWelcome"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4">健康记录历史</h2>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">历史记录列表</h5>
                    </div>
                    <div class="card-body">
                        <div id="recordsList">
                            <p class="text-center">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 记录详情模态框 -->
        <div class="modal fade" id="recordDetailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">健康记录详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="recordDetailContent">
                        <!-- 记录详情内容 -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="exportDetailBtn">导出</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户反馈模态框 -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">提交反馈</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="feedbackForm">
                        <div class="mb-3">
                            <label for="feedbackContent" class="form-label">反馈内容</label>
                            <textarea class="form-control" id="feedbackContent" rows="5" placeholder="请描述您的使用体验、建议或遇到的问题..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="contactInfo" class="form-label">联系方式（选填）</label>
                            <input type="text" class="form-control" id="contactInfo" placeholder="电话/邮箱/微信等">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitFeedback">提交</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI 聊天模态框 -->
    <div class="modal fade" id="aiChatModal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiChatModalLabel"><i class="fas fa-robot"></i> AI 助手</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="aiChatBox" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #f9f9f9;">
                        <!-- 聊天内容将显示在这里 -->
                        <div class="text-muted text-center">你好！我是您的 AI 助手，有什么可以帮助您的吗？</div>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="aiPromptInput" placeholder="请输入您的问题...">
                        <button class="btn btn-primary" type="button" id="sendAiPrompt">
                            <i class="fas fa-paper-plane"></i> 发送
                        </button>
                    </div>
                    <div id="aiCharError" class="text-danger mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="app.js"></script>
    <script>
        // 全局变量存储当前选中的记录
        let currentRecord = null;
        
        // 页面加载完成后检查登录状态并获取历史记录
        document.addEventListener('DOMContentLoaded', function() {
            const auth = checkAuth();
            if (!auth) return;
            
            // 显示用户名
            document.getElementById('userWelcome').textContent = `欢迎, ${auth.currentUser.username}`;
            
            // 获取历史记录
            getHealthRecords(auth.token);
            
            // 导出按钮事件
            document.getElementById('exportDetailBtn').addEventListener('click', function() {
                exportSelectedRecord(auth.token);
            });
            
            // 反馈提交事件
            document.getElementById('submitFeedback').addEventListener('click', function() {
                submitFeedback(auth.token);
            });
            
            // AI 聊天发送按钮事件
            const sendAiPromptButton = document.getElementById('sendAiPrompt');
            if (sendAiPromptButton) {
                sendAiPromptButton.addEventListener('click', function() {
                    sendAiQuery(auth.token);
                });
            }

            // AI 聊天输入框回车事件
            const aiPromptInput = document.getElementById('aiPromptInput');
            if (aiPromptInput) {
                aiPromptInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // 防止表单提交（如果是在form内）
                        sendAiQuery(auth.token);
                    }
                });
            }
        });
        
        // 获取用户健康记录历史
        async function getHealthRecords(token, retryCount = 2) {
            try {
                // 添加加载提示
                document.getElementById('recordsList').innerHTML = `
                    <div class="d-flex justify-content-center align-items-center py-3">
                        <div class="spinner-border text-primary me-2" role="status"></div>
                        <span>正在获取健康记录...</span>
                    </div>
                `;
                
                const records = await apiRequest('/user/health_records', 'POST', null, token);
                
                if (records.length === 0) {
                    document.getElementById('recordsList').innerHTML = `
                        <div class="alert alert-info">您还没有健康记录，请先提交健康信息。</div>
                    `;
                    return;
                }
                
                const recordsHtml = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>检测时间</th>
                                    <th>年龄</th>
                                    <th>BMI</th>
                                    <th>胰岛素</th>
                                    <th>糖尿病风险</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.map(record => {
                                    const riskClass = record.probability > 0.5 ? 'high-risk' : 'low-risk';
                                    const risk = (record.probability * 100).toFixed(1) + '%';
                                    const date = new Date(record.created_at).toLocaleString();
                                    
                                    return `
                                        <tr>
                                            <td>${date}</td>
                                            <td>${record.health_info.age}</td>
                                            <td>${record.health_info.bmi}</td>
                                            <td>${record.health_info.insulin}</td>
                                            <td class="${riskClass}">${risk}</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" 
                                                    onclick="viewRecordDetail(${JSON.stringify(record).replace(/"/g, '&quot;')})">
                                                    查看
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('recordsList').innerHTML = recordsHtml;
            } catch (error) {
                console.error('获取健康记录失败:', error);
                
                // 如果是网络错误并且还有重试次数，则重试
                if ((error.message === 'Failed to fetch' || error.message.includes('网络') || error.message.includes('无法连接') || error.message.includes('超时')) && retryCount > 0) {
                    console.log(`尝试重新获取健康记录(剩余${retryCount}次)...`);
                    document.getElementById('recordsList').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-sync-alt fa-spin me-2"></i>连接服务器失败，正在重新尝试(第${3-retryCount}次)...
                        </div>
                    `;
                    // 延迟一段时间后重试
                    setTimeout(() => {
                        getHealthRecords(token, retryCount - 1);
                    }, 2000);
                    return;
                }
                
                // 显示友好的错误消息
                let errorMessage = error.message;
                if (error.message === 'Failed to fetch') {
                    errorMessage = '无法连接到服务器，请检查网络连接或联系管理员';
                }
                
                document.getElementById('recordsList').innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>获取健康记录失败</h5>
                        <p>${errorMessage}</p>
                        <button class="btn btn-outline-primary mt-2" onclick="getHealthRecords('${token}', 2)">
                            <i class="fas fa-sync-alt me-1"></i>重新加载
                        </button>
                    </div>
                `;
            }
        }
        
        // 查看记录详情
        function viewRecordDetail(record) {
            currentRecord = record;
            
            const riskClass = record.probability > 0.5 ? 'high-risk' : 'low-risk';
            const risk = (record.probability * 100).toFixed(1) + '%';
            const date = new Date(record.created_at).toLocaleString();
            
            let detailHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h4>基本信息</h4>
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>检测时间</span>
                                <span>${date}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>年龄</span>
                                <span>${record.health_info.age}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>BMI指数</span>
                                <span>${record.health_info.bmi}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>胰岛素水平</span>
                                <span>${record.health_info.insulin}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>皮肤厚度</span>
                                <span>${record.health_info.skin_thickness}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>葡萄糖水平</span>
                                <span>${record.health_info.glucose}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>糖尿病风险</span>
                                <span class="${riskClass}">${risk}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h4>预测细节</h4>
                        <canvas id="detailChart"></canvas>
                    </div>
                </div>
            `;
            
            document.getElementById('recordDetailContent').innerHTML = detailHtml;
            
            // 绘制详细图表
            const ctx = document.getElementById('detailChart').getContext('2d');
            const modelData = Object.entries(record.model_details || {}).map(([name, detail]) => ({
                model: name,
                probability: detail.probability
            }));
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: modelData.map(item => item.model),
                    datasets: [{
                        label: '预测概率',
                        data: modelData.map(item => item.probability * 100),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '概率(%)'
                            }
                        }
                    }
                }
            });
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('recordDetailModal'));
            modal.show();
        }
        
        // 导出所选记录
        async function exportSelectedRecord(token) {
            if (!currentRecord) {
                showMessage('没有选择要导出的记录', 'error');
                return;
            }
            
            // 获取导出按钮并显示加载状态
            const exportBtn = document.getElementById('exportDetailBtn');
            const originalBtnText = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>导出中...';
            
            try {
                // 使用Promise.race添加超时处理
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超时
                
                const response = await Promise.race([
                    fetch(`${API_BASE}/user/export_record/${currentRecord.id}`, {
                        headers: { 'Authorization': `Bearer ${token}` },
                        signal: controller.signal
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('请求超时，请稍后重试')), 15000)
                    )
                ]);
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `服务器返回错误状态: ${response.status}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `health_record_${currentRecord.id}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage('记录导出成功', 'success');
            } catch (error) {
                console.error('导出记录失败:', error);
                
                // 显示友好的错误消息
                let errorMsg = error.message;
                if (error.message === 'Failed to fetch') {
                    errorMsg = '无法连接到服务器，请检查网络连接';
                } else if (error.name === 'AbortError' || error.message.includes('超时')) {
                    errorMsg = '导出请求超时，请稍后重试';
                }
                
                showMessage(`导出失败: ${errorMsg}`, 'error');
            } finally {
                // 恢复按钮状态
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalBtnText;
            }
        }
        
        // 提交用户反馈
        async function submitFeedback(token) {
            const content = document.getElementById('feedbackContent').value;
            const contact = document.getElementById('contactInfo').value;
            
            if (!content) {
                showMessage('反馈内容不能为空', 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/user/feedback', 'POST', {
                    content,
                    contact
                }, token);
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                modal.hide();
                
                // 清空表单
                document.getElementById('feedbackContent').value = '';
                document.getElementById('contactInfo').value = '';
                
                showMessage('感谢您的反馈！我们会尽快处理', 'success');
            } catch (error) {
                showMessage(`提交反馈失败: ${error.message}`, 'error');
            }
        }
        
        // 发送AI查询
        async function sendAiQuery(token, retryCount = 1) {
            const promptInput = document.getElementById('aiPromptInput');
            const query = promptInput.value.trim();
            
            if (!query) return;
            
            const chatBox = document.getElementById('aiChatBox');
            const errorDiv = document.getElementById('aiCharError');
            const sendButton = document.getElementById('sendAiPrompt');
            
            // 清空错误信息
            errorDiv.textContent = '';
            
            // 禁用输入框和按钮
            promptInput.disabled = true;
            sendButton.disabled = true;
            const originalBtnHtml = sendButton.innerHTML;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // 添加用户消息
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'mb-2 text-end';
            userMsgDiv.innerHTML = `<span class="bg-primary text-white rounded px-3 py-2 d-inline-block">${query}</span>`;
            chatBox.appendChild(userMsgDiv);
            
            // 保存用户发送的原始查询，用于可能的重试
            const originalQuery = query;
            
            // 清空输入框
            promptInput.value = '';
            
            // 添加AI思考消息
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.className = 'mb-2';
            aiMsgDiv.innerHTML = `<span class="bg-light rounded px-3 py-2 d-inline-block"><i class="fas fa-spinner fa-spin me-2"></i>思考中...</span>`;
            chatBox.appendChild(aiMsgDiv);
            
            // 滚动到底部
            chatBox.scrollTop = chatBox.scrollHeight;
            
            try {
                const response = await Promise.race([
                    apiRequest('/ai/chat', 'POST', { prompt: query }, token),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('AI响应超时，请稍后再试')), 30000) // 30秒超时
                    )
                ]);
                
                // 更新AI回复
                aiMsgDiv.innerHTML = `<span class="bg-light rounded px-3 py-2 d-inline-block">${response.response}</span>`;
                
            } catch (error) {
                console.error("AI请求错误:", error);
                
                // 如果是网络错误并且还有重试次数，则重试
                if ((error.message === 'Failed to fetch' || error.message.includes('网络') || error.message.includes('超时')) && retryCount > 0) {
                    aiMsgDiv.innerHTML = `<span class="bg-warning text-dark rounded px-3 py-2 d-inline-block">
                        <i class="fas fa-sync-alt fa-spin me-2"></i>连接不稳定，正在重试...
                    </span>`;
                    
                    // 延迟1.5秒后重试
                    setTimeout(() => {
                        // 移除当前的AI消息元素
                        chatBox.removeChild(aiMsgDiv);
                        // 重新尝试发送
                        sendAiQuery(token, retryCount - 1);
                    }, 1500);
                    
                    return;
                }
                
                // 显示错误消息
                let errorMessage = error.message;
                if (error.message === 'Failed to fetch') {
                    errorMessage = '无法连接到AI服务，请检查网络连接';
                }
                
                aiMsgDiv.innerHTML = `<span class="bg-danger text-white rounded px-3 py-2 d-inline-block">
                    <i class="fas fa-exclamation-circle me-2"></i>抱歉，发生了错误: ${errorMessage}
                </span>`;
                
                // 添加重试按钮
                const retryDiv = document.createElement('div');
                retryDiv.className = 'text-center mt-2 mb-3';
                retryDiv.innerHTML = `<button class="btn btn-sm btn-outline-primary retry-btn">
                    <i class="fas fa-redo me-1"></i>重试
                </button>`;
                chatBox.appendChild(retryDiv);
                
                // 绑定重试按钮事件
                retryDiv.querySelector('.retry-btn').addEventListener('click', function() {
                    // 移除当前的错误消息和重试按钮
                    chatBox.removeChild(aiMsgDiv);
                    chatBox.removeChild(retryDiv);
                    // 重新填充原始查询
                    promptInput.value = originalQuery;
                    // 启用输入和按钮
                    promptInput.disabled = false;
                    sendButton.disabled = false;
                    sendButton.innerHTML = originalBtnHtml;
                });
                
                errorDiv.textContent = `错误: ${errorMessage}`;
            } finally {
                // 恢复输入框和按钮状态
                promptInput.disabled = false;
                sendButton.disabled = false;
                sendButton.innerHTML = originalBtnHtml;
                
                // 再次滚动到底部
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        
        // 显示消息
        function showMessage(message, type = 'success') {
            // 创建一个警告框
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.role = 'alert';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.maxWidth = '350px';
            alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.display = 'flex';
            alertDiv.style.alignItems = 'center';
            
            // 添加图标
            let icon = 'check-circle';
            if (type === 'error' || type === 'danger') {
                icon = 'exclamation-circle';
            } else if (type === 'warning') {
                icon = 'exclamation-triangle';
            } else if (type === 'info') {
                icon = 'info-circle';
            }
            
            alertDiv.innerHTML = `
                <div class="me-3">
                    <i class="fas fa-${icon} fa-lg"></i>
                </div>
                <div class="flex-grow-1">
                    ${message}
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // 将警告框添加到页面
            document.body.appendChild(alertDiv);
            
            // 添加淡出动画
            setTimeout(() => {
                alertDiv.style.transition = 'opacity 0.5s ease-out';
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        document.body.removeChild(alertDiv);
                    }
                }, 500);
            }, 5000);
            
            // 添加点击关闭功能
            alertDiv.addEventListener('click', function() {
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        document.body.removeChild(alertDiv);
                    }
                }, 500);
            });
        }
    </script>
</body>
</html> 