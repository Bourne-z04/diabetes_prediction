<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>个人资料 - 糖尿病预测系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="user_dashboard.html"><i class="fas fa-heartbeat me-2"></i>糖尿病预测系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user_dashboard.html"><i class="fas fa-file-medical-alt me-1"></i>健康信息</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="user_history.html"><i class="fas fa-history me-1"></i>历史记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="health_plan.html"><i class="fas fa-notes-medical me-1"></i>健康方案</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ai_assistant.html"><i class="fas fa-robot me-1"></i>AI 助手</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="openFeedbackModal" data-bs-toggle="modal" data-bs-target="#feedbackModal"><i class="fas fa-comment-dots me-1"></i>提交反馈</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-user-cog me-1"></i>个人资料</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <img src="images/logo.jpg" alt="Logo" class="me-2" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                    <span class="navbar-text me-3" id="userWelcome"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4">个人资料管理</h2>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <img src="images/logo.jpg" alt="个人头像" class="profile-picture" id="avatarImg" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover;">
                        <h4 id="profileUsername">加载中...</h4>
                        <p class="text-muted" id="profileEmail">加载中...</p>
                        <p class="text-muted" id="profileRole">用户类型: 加载中...</p>
                        <p class="text-muted" id="profileSince">注册时间: 加载中...</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">更新个人信息</h5>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">邮箱</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">新密码（留空表示不修改）</label>
                                <input type="password" class="form-control" id="password">
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">确认新密码</label>
                                <input type="password" class="form-control" id="confirmPassword">
                            </div>
                            <button type="submit" class="btn btn-primary">更新个人资料</button>
                        </form>
                        <div id="result"></div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">账户统计</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h3 id="statsRecords">0</h3>
                                    <p class="text-muted mb-0">健康记录数</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3 text-center">
                                    <h3 id="statsLastTest">-</h3>
                                    <p class="text-muted mb-0">最近一次检测</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户反馈模态框 -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feedbackModalLabel">提交反馈</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="feedbackForm">
                        <div class="mb-3">
                            <label for="feedbackContent" class="form-label">反馈内容</label>
                            <textarea class="form-control" id="feedbackContent" rows="5" placeholder="请描述您的使用体验、建议或遇到的问题..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="contactInfo" class="form-label">联系方式（选填）</label>
                            <input type="text" class="form-control" id="contactInfo" placeholder="电话/邮箱/微信等">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitFeedback">提交</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        // 页面加载完成后检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            const auth = checkAuth();
            if (!auth) return;
            
            // 显示用户名
            document.getElementById('userWelcome').textContent = `欢迎, ${auth.currentUser.username}`;
            
            // 加载用户资料
            loadUserProfile(auth.token, auth.currentUser.id);
            
            // 加载用户统计信息
            loadUserStats(auth.token);
            
            // 表单提交事件
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateProfile(auth.token, auth.currentUser.id);
            });
            
            // 反馈提交事件
            document.getElementById('submitFeedback').addEventListener('click', function() {
                submitFeedback(auth.token);
            });
        });
        
        // 加载用户资料
        async function loadUserProfile(token, userId) {
            try {
                const user = await apiRequest(`/user/profile`, 'GET', null, token);
                
                // 填充页面信息
                document.getElementById('profileUsername').textContent = user.username;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileRole').textContent = `用户类型: ${user.role_id === 2 ? '管理员' : '普通用户'}`;
                document.getElementById('profileSince').textContent = `注册时间: ${new Date(user.created_at).toLocaleDateString()}`;
                
                // 填充表单
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                
            } catch (error) {
                showMessage(`获取用户资料失败: ${error.message}`, 'error');
            }
        }
        
        // 加载用户统计信息
        async function loadUserStats(token) {
            try {
                const stats = await apiRequest(`/user/stats`, 'GET', null, token);
                
                document.getElementById('statsRecords').textContent = stats.records_count || 0;
                
                if (stats.last_test_date) {
                    const lastTestDate = new Date(stats.last_test_date);
                    document.getElementById('statsLastTest').textContent = lastTestDate.toLocaleDateString();
                } else {
                    document.getElementById('statsLastTest').textContent = '暂无记录';
                }
                
            } catch (error) {
                console.error('获取用户统计信息失败:', error);
            }
        }
        
        // 更新用户资料
        async function updateProfile(token, userId) {
            const userData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value
            };
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // 检查必填字段
            if (!userData.username || !userData.email) {
                showMessage('用户名和邮箱不能为空', 'error');
                return;
            }
            
            // 检查密码
            if (password) {
                if (password !== confirmPassword) {
                    showMessage('两次输入的密码不一致', 'error');
                    return;
                }
                userData.password = password;
            }
            
            try {
                const result = await apiRequest(`/user/profile`, 'PUT', userData, token);
                
                // 更新全局存储的用户信息
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                currentUser.username = userData.username;
                currentUser.email = userData.email;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 更新页面上的用户名
                document.getElementById('userWelcome').textContent = `欢迎, ${userData.username}`;
                document.getElementById('profileUsername').textContent = userData.username;
                document.getElementById('profileEmail').textContent = userData.email;
                
                // 清空密码字段
                document.getElementById('password').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showMessage('用户资料更新成功');
            } catch (error) {
                showMessage(`更新用户资料失败: ${error.message}`, 'error');
            }
        }
        
        // 提交用户反馈
        async function submitFeedback(token) {
            const content = document.getElementById('feedbackContent').value;
            const contact = document.getElementById('contactInfo').value;
            
            if (!content) {
                showMessage('反馈内容不能为空', 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/user/feedback', 'POST', {
                    content,
                    contact
                }, token);
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                modal.hide();
                
                // 清空表单
                document.getElementById('feedbackContent').value = '';
                document.getElementById('contactInfo').value = '';
                
                showMessage('感谢您的反馈！我们会尽快处理', 'success');
            } catch (error) {
                showMessage(`提交反馈失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html> 